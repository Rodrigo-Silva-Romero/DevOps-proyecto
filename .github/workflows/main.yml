deploy:
  name: Deploy ECS (JSON Task)
  runs-on: ubuntu-latest
  needs: build_and_push

  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Download image outputs
      uses: actions/download-artifact@v4
      with:
        name: image-outputs

    - name: Load variables
      id: vars
      run: |
        source image-outputs.env

        echo "api=$API_IMAGE" >> $GITHUB_ENV
        echo "product=$PRODUCT_IMAGE" >> $GITHUB_ENV
        echo "inventory=$INVENTORY_IMAGE" >> $GITHUB_ENV

    - name: Generate updated TaskDefinition JSON
      run: |
        sed \
          -e "s|\${APIGATEWAY_IMAGE}|${{ env.api }}|g" \
          -e "s|\${PRODUCT_IMAGE}|${{ env.product }}|g" \
          -e "s|\${INVENTORY_IMAGE}|${{ env.inventory }}|g" \
          infra/ecs-task/task-definition.json > final-task.json

    #  REGISTRAMOS LA NUEVA TASK Y CAPTURAMOS EL ARN
    - name: Register new TaskDefinition in ECS
      id: register
      run: |
        NEW_TASK_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://final-task.json \
          --query "taskDefinition.taskDefinitionArn" \
          --output text)

        echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV
        echo "Nueva task registrada: $NEW_TASK_ARN"

    #  LE DECIMOS A ECS: "US√Å ESTA TASK NUEVA"
    - name: Update ECS Service with new Task Definition
      run: |
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --task-definition ${{ env.NEW_TASK_ARN }} \
          --desired-count 1 \
          --force-new-deployment

    - name: Completed
      run: echo "üöÄ Deploy ECS JSON ejecutado correctamente."
